package com.lv.pacientes.controlador;

package com.optica.controlador;

import com.lv.pacientes.dao.*;
import com.lv..modelo.Paciente;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonSerializer;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet("/pacientes")
public class ControladorPacientes extends HttpServlet {
    
    private PacienteDAO pacienteDAO;
    private Gson gson;
    
    @Override
    public void init() throws ServletException {
        pacienteDAO = new PacienteDAO();
        
        // Configurar Gson para serializar LocalDate
        gson = new GsonBuilder()
                .registerTypeAdapter(LocalDate.class, 
                    (JsonSerializer<LocalDate>) (src, typeOfSrc, context) -> 
                        context.serialize(src.toString()))
                .create();
    }
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        String accion = request.getParameter("accion");
        
        if (accion == null) {
            accion = "listar";
        }
        
        try {
            switch (accion) {
                case "listar":
                    listar(request, response);
                    break;
                case "buscar":
                    buscar(request, response);
                    break;
                case "obtener":
                    obtener(request, response);
                    break;
                default:
                    listar(request, response);
            }
        } catch (Exception e) {
            e.printStackTrace();
            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, 
                             "Error en el servidor: " + e.getMessage());
        }
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        request.setCharacterEncoding("UTF-8");
        String accion = request.getParameter("accion");
        
        try {
            switch (accion) {
                case "guardar":
                    guardar(request, response);
                    break;
                case "editar":
                    editar(request, response);
                    break;
                case "eliminar":
                    eliminar(request, response);
                    break;
                default:
                    enviarRespuestaError(response, "Acción no válida");
            }
        } catch (Exception e) {
            e.printStackTrace();
            enviarRespuestaError(response, "Error en el servidor: " + e.getMessage());
        }
    }
    
    private void listar(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        List<Paciente> pacientes = pacienteDAO.obtenerActivos();
        request.setAttribute("pacientes", pacientes);
        request.getRequestDispatcher("/WEB-INF/views/pacientes.jsp").forward(request, response);
    }
    
    private void buscar(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        String criterio = request.getParameter("criterio");
        List<Paciente> pacientes;
        
        if (criterio == null || criterio.trim().isEmpty()) {
            pacientes = pacienteDAO.obtenerActivos();
        } else {
            pacientes = pacienteDAO.buscar(criterio);
        }
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(pacientes));
    }
    
    private void obtener(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        Long id = Long.parseLong(request.getParameter("id"));
        Paciente paciente = pacienteDAO.buscarPorId(id);
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(paciente));
    }
    
    private void guardar(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        
        // Validar campos obligatorios
        String nombre = request.getParameter("nombre");
        String apellido = request.getParameter("apellido");
        String cedula = request.getParameter("cedula");
        String fechaNacStr = request.getParameter("fechaNacimiento");
        
        Map<String, String> respuesta = new HashMap<>();
        
        if (nombre == null || nombre.trim().isEmpty() ||
            apellido == null || apellido.trim().isEmpty() ||
            cedula == null || cedula.trim().isEmpty() ||
            fechaNacStr == null || fechaNacStr.trim().isEmpty()) {
            
            enviarRespuestaError(response, "Faltan campos obligatorios");
            return;
        }
        
        // Validar cédula ecuatoriana
        if (!validarCedulaEcuatoriana(cedula)) {
            enviarRespuestaError(response, "Cédula ecuatoriana no válida");
            return;
        }
        
        // Verificar si la cédula ya existe
        if (pacienteDAO.existeCedula(cedula, null)) {
            enviarRespuestaError(response, "La cédula ya está registrada");
            return;
        }
        
        // Crear paciente
        Paciente paciente = new Paciente();
        paciente.setNombre(nombre.trim());
        paciente.setApellido(apellido.trim());
        paciente.setCedula(cedula.trim());
        paciente.setFechaNacimiento(LocalDate.parse(fechaNacStr));
        paciente.setTelefono(request.getParameter("telefono"));
        paciente.setCorreoElectronico(request.getParameter("email"));
        paciente.setDireccion(request.getParameter("direccion"));
        paciente.setOcupacion(request.getParameter("ocupacion"));
        paciente.setAntecedentesOculares(request.getParameter("antecedentesOculares"));
        paciente.setAntecedentesMedicos(request.getParameter("antecedentesMedicos"));
        paciente.setAntecedentesFamiliares(request.getParameter("antecedentesFamiliares"));
        paciente.setAntecedentesFarmacologicos(request.getParameter("antecedentesFarmacologicos"));
        
        pacienteDAO.crear(paciente);
        
        respuesta.put("success", "true");
        respuesta.put("message", "Paciente registrado exitosamente");
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(respuesta));
    }
    
    private void editar(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        
        Long id = Long.parseLong(request.getParameter("id"));
        String cedula = request.getParameter("cedula");
        
        Map<String, String> respuesta = new HashMap<>();
        
        // Validar cédula ecuatoriana
        if (!validarCedulaEcuatoriana(cedula)) {
            enviarRespuestaError(response, "Cédula ecuatoriana no válida");
            return;
        }
        
        // Verificar si la cédula ya existe (excluyendo el ID actual)
        if (pacienteDAO.existeCedula(cedula, id)) {
            enviarRespuestaError(response, "La cédula ya está registrada");
            return;
        }
        
        Paciente paciente = pacienteDAO.buscarPorId(id);
        if (paciente == null) {
            enviarRespuestaError(response, "Paciente no encontrado");
            return;
        }
        
        paciente.setNombre(request.getParameter("nombre").trim());
        paciente.setApellido(request.getParameter("apellido").trim());
        paciente.setCedula(cedula.trim());
        paciente.setFechaNacimiento(LocalDate.parse(request.getParameter("fechaNacimiento")));
        paciente.setTelefono(request.getParameter("telefono"));
        paciente.setCorreoElectronico(request.getParameter("email"));
        paciente.setDireccion(request.getParameter("direccion"));
        paciente.setOcupacion(request.getParameter("ocupacion"));
        paciente.setAntecedentesOculares(request.getParameter("antecedentesOculares"));
        paciente.setAntecedentesMedicos(request.getParameter("antecedentesMedicos"));
        paciente.setAntecedentesFamiliares(request.getParameter("antecedentesFamiliares"));
        paciente.setAntecedentesFarmacologicos(request.getParameter("antecedentesFarmacologicos"));
        
        pacienteDAO.actualizar(paciente);
        
        respuesta.put("success", "true");
        respuesta.put("message", "Paciente actualizado exitosamente");
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(respuesta));
    }
    
    private void eliminar(HttpServletRequest request, HttpServletResponse response) 
            throws Exception {
        
        Long id = Long.parseLong(request.getParameter("id"));
        pacienteDAO.eliminarLogico(id);
        
        Map<String, String> respuesta = new HashMap<>();
        respuesta.put("success", "true");
        respuesta.put("message", "Paciente eliminado exitosamente");
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(respuesta));
    }
    
    private void enviarRespuestaError(HttpServletResponse response, String mensaje) 
            throws IOException {
        Map<String, String> respuesta = new HashMap<>();
        respuesta.put("success", "false");
        respuesta.put("message", mensaje);
        
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");
        response.getWriter().write(gson.toJson(respuesta));
    }
    
    /**
     * Validación de cédula ecuatoriana usando el algoritmo módulo 10
     */
    private boolean validarCedulaEcuatoriana(String cedula) {
        if (cedula == null || cedula.length() != 10) {
            return false;
        }
        
        try {
            int[] coeficientes = {2, 1, 2, 1, 2, 1, 2, 1, 2};
            int suma = 0;
            int digitoVerificador = Integer.parseInt(cedula.substring(9, 10));
            
            for (int i = 0; i < 9; i++) {
                int digito = Integer.parseInt(cedula.substring(i, i + 1));
                int producto = digito * coeficientes[i];
                
                if (producto >= 10) {
                    producto -= 9;
                }
                
                suma += producto;
            }
            
            int resultado = suma % 10;
            int digitoEsperado = (resultado == 0) ? 0 : 10 - resultado;
            
            return digitoVerificador == digitoEsperado;
        } catch (NumberFormatException e) {
            return false;
        }
    }
}